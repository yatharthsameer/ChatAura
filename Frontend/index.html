<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <!-- GitHub Markdown CSS for beautiful styling -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
  <style>
    html,
    body {
      margin: 0;
      height: 100%;
      background: rgba(30, 30, 30, .85);
      overflow: hidden;
      font-family: monospace;
    }

    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
      padding: 12px;
      box-sizing: border-box;
    }

    /* Top bar styling */
    #topBar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      height: 32px;
      padding: 0 12px;
      background: rgba(20, 20, 20, 0.8);
      border-bottom: 1px solid #555;
      border-radius: 6px 6px 0 0;
      flex-shrink: 0;
      margin-bottom: 8px;
    }

    #infoIcon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(60, 60, 60, 0.8);
      color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font: 12px monospace;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    #infoIcon:hover {
      background: rgba(70, 130, 180, 0.8);
      color: #fff;
    }

    /* Tooltip styling */
    #shortcutsTooltip {
      position: absolute;
      top: 24px;
      right: 0;
      background: rgba(20, 20, 20, 0.95);
      border: 1px solid #555;
      border-radius: 6px;
      padding: 12px;
      min-width: 280px;
      font: 11px monospace;
      color: #eee;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    #shortcutsTooltip.show {
      display: block;
    }

    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid rgba(85, 85, 85, 0.3);
    }

    .shortcut-item:last-child {
      border-bottom: none;
    }

    .shortcut-key {
      color: #70a1d4;
      font-weight: bold;
      background: rgba(70, 130, 180, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
    }

    .shortcut-desc {
      color: #ccc;
      flex: 1;
      margin-left: 8px;
      font-size: 10px;
    }

    .tooltip-title {
      color: #fff;
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
      font-size: 12px;
      border-bottom: 1px solid #555;
      padding-bottom: 6px;
    }

    /* Pages */
    .page {
      flex: 1;
      display: none;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .page.active {
      display: flex;
    }

    /* Notes page - Updated for markdown rendering */
    #solution {
      flex: 1;
      border: none;
      outline: none;
      background: rgba(40, 40, 40, .9);
      color: #fff;
      padding: 12px;
      display: block;
      border-top: 1px solid #555;
      border-radius: 6px 6px 0 0;
      overflow-y: auto;
      overflow-x: hidden;
      font-size: 13px;
      line-height: 1.4;
      box-sizing: border-box;
      word-wrap: break-word;
      /* Hide scrollbar */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }

    #solution::-webkit-scrollbar {
      display: none; /* WebKit */
    }

    /* Markdown styling overrides for dark theme */
    #solution.markdown-body {
      background: rgba(40, 40, 40, .9) !important;
      color: #fff !important;
      font-size: 13px !important;
      line-height: 1.4 !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
    }

    #solution.markdown-body h1,
    #solution.markdown-body h2,
    #solution.markdown-body h3,
    #solution.markdown-body h4,
    #solution.markdown-body h5,
    #solution.markdown-body h6 {
      color: #fff !important;
      border-bottom-color: #555 !important;
    }

    #solution.markdown-body pre {
      background: rgba(20, 20, 20, .8) !important;
      border: 1px solid #555 !important;
      overflow-x: auto !important;
      word-wrap: normal !important;
      white-space: pre !important;
    }

    #solution.markdown-body code {
      background: rgba(20, 20, 20, .6) !important;
      color: #f8f8f2 !important;
      border: 1px solid #444 !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }

    #solution.markdown-body blockquote {
      color: #ccc !important;
      border-left-color: #666 !important;
    }

    #solution.markdown-body table tr {
      background: rgba(50, 50, 50, .5) !important;
      border-top-color: #555 !important;
    }

    #solution.markdown-body table tr:nth-child(2n) {
      background: rgba(60, 60, 60, .5) !important;
    }

    #solution.markdown-body table th,
    #solution.markdown-body table td {
      border-color: #555 !important;
    }

    #solution.markdown-body a {
      color: #79b8ff !important;
    }

    #solution.markdown-body strong {
      color: #fff !important;
    }

    /* Ensure all text content wraps properly */
    #solution.markdown-body p,
    #solution.markdown-body li,
    #solution.markdown-body div,
    #solution.markdown-body span {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      hyphens: auto !important;
      max-width: 100% !important;
    }

    /* Fix code blocks to prevent horizontal overflow */
    #solution.markdown-body pre code {
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }

    /* Empty state styling */
    #solution.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      font-style: italic;
    }

    /* Pencil icon for prompt editing */
    #promptEditIcon {
      position: absolute;
      top: 40px;
      right: 12px;
      width: 32px;
      height: 32px;
      background: rgba(70, 130, 180, 0.8);
      border: 1px solid #555;
      border-radius: 6px;
      display: none;
      align-items: center;
      justify-content: center;
      font: 14px monospace;
      font-weight: bold;
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s;
      color: #fff;
    }

    #promptEditIcon:hover {
      background: rgba(70, 130, 180, 1);
      border-color: #888;
      transform: scale(1.05);
    }

    /* Show pencil icon only when in notes page */
    .page.active #promptEditIcon {
      display: flex;
    }

    /* Error notification area */
    #errorNotification {
      position: fixed;
      top: 50px;
      right: 20px;
      background: rgba(180, 70, 70, 0.95);
      color: #fff;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #a66;
      font: 12px monospace;
      max-width: 300px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      word-wrap: break-word;
    }

    #errorNotification.show {
      display: block;
    }

    #errorNotification .error-close {
      float: right;
      margin-left: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #fff;
    }

    #errorNotification .error-close:hover {
      color: #ccc;
    }

    /* Prompt edit modal */
    #promptEditModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    #promptEditModal.show {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 30, 30, 0.95);
      border: 1px solid #555;
      border-radius: 8px;
      padding: 20px;
      width: 500px;
      max-width: 90%;
      font: 12px monospace;
      color: #fff;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #555;
    }

    .modal-title {
      font-size: 14px;
      font-weight: bold;
      color: #fff;
    }

    .modal-close {
      background: none;
      border: none;
      color: #ccc;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
    }

    .modal-close:hover {
      background: rgba(180, 70, 70, 0.8);
      color: #fff;
    }

    .modal-body {
      margin-bottom: 15px;
    }

    .prompt-textarea {
      width: 100%;
      height: 120px;
      background: rgba(40, 40, 40, 0.9);
      border: 1px solid #555;
      border-radius: 4px;
      padding: 10px;
      color: #fff;
      font: 12px monospace;
      resize: vertical;
      outline: none;
    }

    .prompt-textarea:focus {
      border-color: #70a1d4;
      box-shadow: 0 0 0 2px rgba(70, 130, 180, 0.2);
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 8px 16px;
      border: 1px solid #666;
      border-radius: 4px;
      cursor: pointer;
      font: 12px monospace;
      transition: all 0.2s;
    }

    .modal-btn.primary {
      background: rgba(70, 130, 180, 0.8);
      color: #fff;
    }

    .modal-btn.primary:hover {
      background: rgba(70, 130, 180, 1);
    }

    .modal-btn.secondary {
      background: rgba(60, 60, 60, 0.8);
      color: #ccc;
    }

    .modal-btn.secondary:hover {
      background: rgba(80, 80, 80, 0.9);
      color: #fff;
    }

    .prompt-info {
      font-size: 11px;
      color: #888;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    /* Loader styling */
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      background: rgba(30, 30, 30, 0.95);
      padding: 24px;
      border-radius: 8px;
      border: 1px solid #555;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid #70a1d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader-text {
      color: #ccc;
      font: 13px monospace;
      text-align: center;
    }

    .loader-subtext {
      color: #888;
      font: 11px monospace;
      text-align: center;
    }

    /* Chat page */
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      min-height: 0;
      overflow: hidden;
      height: 0; /* Force flex child to respect parent constraints */
      background: rgba(40, 40, 40, .9);
      border-radius: 6px 6px 0 0;
    }

    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      height: 0; /* Force flex child to respect parent constraints */
      /* Hide scrollbar */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }

    #chatMessages::-webkit-scrollbar {
      display: none; /* WebKit */
    }

    #chatInputContainer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px 0;
      border-top: 1px solid #555;
      flex-shrink: 0;
    }

    /* Image preview in chat */
    #imagePreviewContainer {
      position: relative;
      align-self: flex-start;
      max-width: 200px;
    }
    
    #imagePreview {
      width: 100%;
      max-width: 200px;
      height: auto;
      border-radius: 8px;
      border: 1px solid #666;
    }
    
    #removeImageBtn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: rgba(180, 70, 70, .9);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font: 12px monospace;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #inputRow {
      display: flex;
      gap: 8px;
    }

    #chatInput {
      flex: 1;
      padding: 8px;
      background: rgba(60, 60, 60, .8);
      color: #eee;
      border: 1px solid #666;
      border-radius: 4px;
      font: 13px monospace;
      outline: none;
    }

    #sendBtn {
      padding: 8px 12px;
      background: rgba(70, 130, 180, .8);
      color: #fff;
      border: 1px solid #5a9fd4;
      border-radius: 4px;
      cursor: pointer;
      font: 12px monospace;
      min-width: 60px;
    }

    #sendBtn:hover {
      background: rgba(90, 150, 200, .9);
    }

    #sendBtn:disabled {
      background: rgba(50, 50, 50, .5);
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Chat bubbles - Updated for markdown */
    .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      margin: 2px 0;
      word-wrap: break-word;
      font: 13px/1.4 monospace;
    }

    .message.user {
      background: rgba(70, 130, 180, .8);
      color: #fff;
      align-self: flex-end;
    }

    .message.ai {
      background: rgba(60, 60, 60, .8);
      color: #eee;
      align-self: flex-start;
    }

    .message.error {
      background: rgba(180, 70, 70, .8);
      color: #fff;
      align-self: flex-start;
    }

    /* Markdown styling for chat messages */
    .message.markdown-body {
      font-size: 13px !important;
      line-height: 1.4 !important;
    }

    .message.ai.markdown-body {
      background: rgba(60, 60, 60, .8) !important;
      color: #eee !important;
    }

    .message.ai.markdown-body h1,
    .message.ai.markdown-body h2,
    .message.ai.markdown-body h3,
    .message.ai.markdown-body h4,
    .message.ai.markdown-body h5,
    .message.ai.markdown-body h6 {
      color: #fff !important;
      border-bottom-color: #555 !important;
      margin: 8px 0 4px 0 !important;
    }

    .message.ai.markdown-body pre {
      background: rgba(20, 20, 20, .8) !important;
      border: 1px solid #444 !important;
      margin: 8px 0 !important;
    }

    .message.ai.markdown-body code {
      background: rgba(20, 20, 20, .6) !important;
      color: #f8f8f2 !important;
      border: 1px solid #333 !important;
    }

    .message.ai.markdown-body blockquote {
      color: #ccc !important;
      border-left-color: #666 !important;
      margin: 8px 0 !important;
    }

    .message.ai.markdown-body a {
      color: #79b8ff !important;
    }

    .message.ai.markdown-body strong {
      color: #fff !important;
    }

    .message.ai.markdown-body ul,
    .message.ai.markdown-body ol {
      margin: 8px 0 !important;
      padding-left: 20px !important;
    }

    .message.ai.markdown-body p {
      margin: 8px 0 !important;
    }

    /* Common elements */
    #buttonContainer {
      display: flex;
      padding: 16px;
      gap: 8px;
      border-top: 1px solid #555;
      background: rgba(20, 20, 20, .9);
      border-radius: 0 0 6px 6px;
    }

    .btn {
      flex: 1;
      padding: 8px 12px;
      background: rgba(60, 60, 60, .8);
      color: #eee;
      border: 1px solid #666;
      border-radius: 4px;
      cursor: pointer;
      font: 12px monospace;
      text-align: center;
      transition: all 0.2s;
    }

    .btn:hover {
      background: rgba(80, 80, 80, .9);
      border-color: #888;
    }

    .btn:active {
      background: rgba(100, 100, 100, .9);
    }

    .btn.active {
      background: rgba(70, 130, 180, .8);
      border-color: #5a9fd4;
    }

    .btn.clear {
      background: rgba(80, 50, 50, .8);
      border-color: #a66;
    }

    .btn.clear:hover {
      background: rgba(100, 60, 60, .9);
    }

    .error {
      color: #f44 !important;
    }

    .loading {
      color: #fa0 !important;
    }
    
    /* Screenshot Preview Area */
    #screenshotPreviewArea { 
      display:none; 
      padding:12px 16px; 
      background:rgba(50,50,50,.9); 
      border-top:1px solid #555; 
      flex-shrink:0; 
      max-height:120px; 
      overflow-y:auto; 
    }
    #screenshotPreviewContainer { 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      align-items:center; 
    }
    .screenshot-preview { 
      position:relative; 
      display:inline-block; 
    }
    .screenshot-preview img { 
      width:80px; 
      height:60px; 
      object-fit:cover; 
      border-radius:4px; 
      border:1px solid #666; 
    }
    .screenshot-remove { 
      position:absolute; 
      top:-4px; 
      right:-4px; 
      width:16px; 
      height:16px; 
      background:rgba(180,70,70,.9); 
      color:#fff; 
      border:none; 
      border-radius:50%; 
      cursor:pointer; 
      font:10px monospace; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
    }
    #screenshotCount { 
      color:#888; 
      font:12px monospace; 
      margin-left:8px; 
    }
    #processHint { 
      color:#888; 
      font:11px monospace; 
      margin-left:auto; 
    }

    /* Chat Screenshot Preview Area */
    #chatScreenshotPreviewArea { 
      display:none; 
      padding:12px 16px; 
      background:rgba(50,50,50,.9); 
      border-top:1px solid #555; 
      flex-shrink:0; 
      max-height:120px; 
      overflow-y:auto; 
    }
    #chatScreenshotPreviewContainer { 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      align-items:center; 
    }
    #chatScreenshotCount { 
      color:#888; 
      font:12px monospace; 
      margin-left:8px; 
    }
    #chatProcessHint { 
      color:#888; 
      font:11px monospace; 
      margin-left:auto; 
    }

    #solution.markdown-body p,
    #solution.markdown-body li,
    #solution.markdown-body div {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
    }

    /* Top bar styling */
    #topBar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      height: 32px;
      padding: 0 12px;
      background: rgba(20, 20, 20, 0.8);
      border-bottom: 1px solid #555;
      border-radius: 6px 6px 0 0;
      flex-shrink: 0;
      margin-bottom: 8px;
    }

    #infoIcon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(60, 60, 60, 0.8);
      color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font: 12px monospace;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }

    #infoIcon:hover {
      background: rgba(70, 130, 180, 0.8);
      color: #fff;
    }

    /* Tooltip styling */
    #shortcutsTooltip {
      position: absolute;
      top: 24px;
      right: 0;
      background: rgba(20, 20, 20, 0.95);
      border: 1px solid #555;
      border-radius: 6px;
      padding: 12px;
      min-width: 280px;
      font: 11px monospace;
      color: #eee;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    #shortcutsTooltip.show {
      display: block;
    }

    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid rgba(85, 85, 85, 0.3);
    }

    .shortcut-item:last-child {
      border-bottom: none;
    }

    .shortcut-key {
      color: #70a1d4;
      font-weight: bold;
      background: rgba(70, 130, 180, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
    }

    .shortcut-desc {
      color: #ccc;
      flex: 1;
      margin-left: 8px;
      font-size: 10px;
    }

    .tooltip-title {
      color: #fff;
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
      font-size: 12px;
      border-bottom: 1px solid #555;
      padding-bottom: 6px;
    }

    /* Model selector styling */
    #modelSelector {
      flex: 1;
      display: flex;
      align-items: center;
    }

    #modelDropdown {
      background: rgba(40, 40, 40, 0.9);
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 10px;
      font: 12px monospace;
      outline: none;
      cursor: pointer;
      min-width: 140px;
      transition: all 0.2s;
    }

    #modelDropdown:hover {
      background: rgba(50, 50, 50, 0.9);
      border-color: #70a1d4;
    }

    #modelDropdown:focus {
      border-color: #70a1d4;
      box-shadow: 0 0 4px rgba(112, 161, 212, 0.3);
    }

    #modelDropdown option {
      background: rgba(30, 30, 30, 0.95);
      color: #eee;
      padding: 4px;
    }

    /* Settings icon styling */
    #settingsIcon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(60, 60, 60, 0.8);
      color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font: 12px monospace;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      margin-right: 10px;
    }

    #settingsIcon:hover {
      background: rgba(70, 130, 180, 0.8);
      color: #fff;
    }

    /* Logout icon styling */
    #logoutIcon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(60, 60, 60, 0.8);
      color: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font: 12px monospace;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      margin-right: 10px;
    }

    #logoutIcon:hover {
      background: rgba(220, 53, 69, 0.8);
      color: #fff;
    }

    /* Logout tooltip styling */
    #logoutTooltip {
      position: absolute;
      top: 24px;
      right: 0;
      background: rgba(20, 20, 20, 0.95);
      border: 1px solid #555;
      border-radius: 6px;
      padding: 12px;
      min-width: 200px;
      font: 11px monospace;
      color: #eee;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    #logoutTooltip.show {
      display: block;
    }

    .tooltip-content {
      color: #ccc;
      font-size: 10px;
      text-align: center;
      margin-top: 6px;
    }

    /* Settings dropdown styling */
    #settingsDropdown {
      position: absolute;
      top: 24px;
      right: 0;
      background: rgba(20, 20, 20, 0.95);
      border: 1px solid #555;
      border-radius: 6px;
      padding: 12px;
      min-width: 200px;
      font: 11px monospace;
      color: #eee;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    #settingsDropdown.show {
      display: block;
    }

    .settings-title {
      color: #fff;
      font-weight: bold;
      margin-bottom: 12px;
      text-align: center;
      font-size: 12px;
      border-bottom: 1px solid #555;
      padding-bottom: 6px;
    }

    .settings-item {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .settings-item:last-child {
      margin-bottom: 0;
    }

    .settings-item label {
      color: #ccc;
      font-size: 10px;
      font-weight: bold;
    }

    #themeSelector {
      background: rgba(40, 40, 40, 0.9);
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px 6px;
      font: 10px monospace;
      outline: none;
      cursor: pointer;
    }

    #themeSelector:hover {
      background: rgba(50, 50, 50, 0.9);
      border-color: #70a1d4;
    }

    #themeSelector option {
      background: rgba(30, 30, 30, 0.95);
      color: #eee;
    }

    #opacitySlider {
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: rgba(60, 60, 60, 0.8);
      outline: none;
      -webkit-appearance: none;
    }

    #opacitySlider::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #70a1d4;
      cursor: pointer;
    }

    #opacitySlider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #70a1d4;
      cursor: pointer;
      border: none;
    }

    #opacityValue {
      color: #70a1d4;
      font-size: 10px;
      font-weight: bold;
      text-align: center;
    }

    /* Light theme styles */
    body.light-theme {
      background: rgba(240, 240, 240, .85);
    }

    body.light-theme #container {
      color: #333;
    }

    body.light-theme #topBar {
      background: rgba(220, 220, 220, 0.9);
      border-bottom: 1px solid #ccc;
    }

    body.light-theme #infoIcon,
    body.light-theme #settingsIcon {
      background: rgba(180, 180, 180, 0.8);
      color: #333;
    }

    body.light-theme #infoIcon:hover,
    body.light-theme #settingsIcon:hover {
      background: rgba(70, 130, 180, 0.8);
      color: #fff;
    }

    body.light-theme #logoutIcon {
      background: rgba(180, 180, 180, 0.8);
      color: #333;
    }

    body.light-theme #logoutIcon:hover {
      background: rgba(220, 53, 69, 0.8);
      color: #fff;
    }

    body.light-theme #shortcutsTooltip,
    body.light-theme #settingsDropdown {
      background: rgba(240, 240, 240, 0.95);
      border: 1px solid #ccc;
      color: #333;
    }

    body.light-theme #logoutTooltip {
      background: rgba(240, 240, 240, 0.95);
      border: 1px solid #ccc;
      color: #333;
    }

    body.light-theme .tooltip-title,
    body.light-theme .settings-title {
      color: #333;
      border-bottom-color: #ccc;
    }

    body.light-theme .shortcut-item {
      border-bottom-color: rgba(200, 200, 200, 0.5);
    }

    body.light-theme .shortcut-desc,
    body.light-theme .settings-item label {
      color: #666;
    }

    body.light-theme #modelDropdown,
    body.light-theme #themeSelector {
      background: rgba(220, 220, 220, 0.9);
      color: #333;
      border: 1px solid #ccc;
    }

    body.light-theme #modelDropdown:hover,
    body.light-theme #themeSelector:hover {
      background: rgba(200, 200, 200, 0.9);
      border-color: #70a1d4;
    }

    body.light-theme #modelDropdown option,
    body.light-theme #themeSelector option {
      background: rgba(240, 240, 240, 0.95);
      color: #333;
    }

    body.light-theme #solution {
      background: rgba(250, 250, 250, .9);
      color: #333;
      border-top: 1px solid #ccc;
    }

    body.light-theme #solution.markdown-body {
      background: rgba(250, 250, 250, .9) !important;
      color: #333 !important;
    }

    body.light-theme #solution.markdown-body h1,
    body.light-theme #solution.markdown-body h2,
    body.light-theme #solution.markdown-body h3,
    body.light-theme #solution.markdown-body h4,
    body.light-theme #solution.markdown-body h5,
    body.light-theme #solution.markdown-body h6 {
      color: #333 !important;
      border-bottom-color: #ccc !important;
    }

    body.light-theme #solution.markdown-body pre {
      background: rgba(240, 240, 240, .8) !important;
      border: 1px solid #ccc !important;
    }

    body.light-theme #solution.markdown-body code {
      background: rgba(230, 230, 230, .8) !important;
      color: #333 !important;
      border: 1px solid #ccc !important;
    }

    body.light-theme #solution.markdown-body blockquote {
      color: #666 !important;
      border-left-color: #ccc !important;
    }

    body.light-theme #chatContainer {
      background: rgba(250, 250, 250, .9);
    }

    body.light-theme #chatInput {
      background: rgba(230, 230, 230, .8);
      color: #333;
      border: 1px solid #ccc;
    }

    body.light-theme #sendBtn {
      background: rgba(70, 130, 180, .8);
      border: 1px solid #5a9fd4;
    }

    body.light-theme #opacitySlider {
      background: rgba(200, 200, 200, 0.8);
    }

    /* Light theme chat message styling */
    body.light-theme .message.user {
      background: rgba(70, 130, 180, 0.1);
      color: #333;
    }

    body.light-theme .message.ai {
      background: rgba(220, 220, 220, 0.8);
      color: #333;
    }

    body.light-theme .message.error {
      background: rgba(220, 53, 69, 0.1);
      color: #721c24;
    }

    /* Light theme button styling */
    body.light-theme .btn {
      background: rgba(220, 220, 220, 0.8);
      color: #333;
      border: 1px solid #ccc;
    }

    body.light-theme .btn:hover {
      background: rgba(200, 200, 200, 0.9);
      border-color: #70a1d4;
    }

    body.light-theme .btn.active {
      background: rgba(70, 130, 180, 0.8);
      color: #fff;
      border-color: #5a9fd4;
    }

    body.light-theme .btn.clear {
      background: rgba(220, 53, 69, 0.8);
      color: #fff;
      border-color: #c82333;
    }

    body.light-theme .btn.clear:hover {
      background: rgba(200, 43, 59, 0.9);
    }

    /* Light theme screenshot preview styling */
    body.light-theme #screenshotPreviewArea {
      background: rgba(240, 240, 240, 0.9);
      border-top: 1px solid #ccc;
    }

    body.light-theme #screenshotCount {
      color: #666;
    }

    body.light-theme #processHint {
      color: #999;
    }

    body.light-theme .screenshot-remove {
      background: rgba(220, 53, 69, 0.9);
      color: #fff;
    }

    /* Light theme chat screenshot preview styling */
    body.light-theme #chatScreenshotPreviewArea {
      background: rgba(240, 240, 240, 0.9);
      border-top: 1px solid #ccc;
    }

    body.light-theme #chatScreenshotCount {
      color: #666;
    }

    body.light-theme #chatProcessHint {
      color: #999;
    }

    /* Light theme button container styling */
    body.light-theme #buttonContainer {
      background: rgba(220, 220, 220, 0.9);
      border-top: 1px solid #ccc;
    }
  </style>
</head>

<body>
  <!-- Error notification -->
  <div id="errorNotification">
    <span class="error-close" onclick="hideErrorNotification()">×</span>
    <span id="errorMessage"></span>
  </div>
  <div id="container">
    <!-- Top bar -->
    <div id="topBar">
      <div id="modelSelector">
        <select id="modelDropdown">
          <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
          <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o Mini</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </select>
      </div>
      <div id="logoutIcon">
        ⏻
        <div id="logoutTooltip">
          <div class="tooltip-title">Logout</div>
          <div class="tooltip-content">Sign out and return to login screen</div>
        </div>
      </div>
      <div id="settingsIcon">
        ⚙
        <div id="settingsDropdown">
          <div class="settings-title">Settings</div>
          <div class="settings-item">
            <label for="themeSelector">Theme:</label>
            <select id="themeSelector">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>
          <div class="settings-item">
            <label for="opacitySlider">Opacity:</label>
            <input type="range" id="opacitySlider" min="20" max="100" value="100" />
            <span id="opacityValue">100%</span>
          </div>
        </div>
      </div>
      <div id="infoIcon">
        i
        <div id="shortcutsTooltip">
          <div class="tooltip-title">Keyboard Shortcuts</div>
          <div class="shortcut-item">
            <span class="shortcut-key">Cmd+Shift+1</span>
            <span class="shortcut-desc">Take screenshot</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-key">Cmd+Enter</span>
            <span class="shortcut-desc">Process accumulated screenshots</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-key">Cmd+↑↓←→</span>
            <span class="shortcut-desc">Move window</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-key">Cmd+6</span>
            <span class="shortcut-desc">Hide/Show window</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-key">Enter / Cmd+Enter</span>
            <span class="shortcut-desc">Send chat message</span>
          </div>
          <div class="shortcut-item">
            <span class="shortcut-key">Cmd+Shift+I</span>
            <span class="shortcut-desc">Switch to chat mode</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Page -->
    <div id="notesPage" class="page active">
      <!-- Pencil icon for prompt editing -->
      <div id="promptEditIcon" title="Edit custom prompt">✏️</div>
      <!-- Solution display area - Changed from textarea to div for markdown -->
      <div id="solution" class="markdown-body empty">Screenshot solution will appear here...</div>
      <!-- Screenshot Preview Area -->
      <div id="screenshotPreviewArea">
        <div id="screenshotPreviewContainer">
          <span id="screenshotCount">0 screenshots</span>
          <span id="processHint">Press Cmd+Enter to process</span>
        </div>
      </div>
      <!-- Loader -->
      <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">Processing screenshots...</div>
        <div class="loader-subtext">Analyzing with AI</div>
      </div>
    </div>

    <!-- Chat Page -->
    <div id="chatPage" class="page">
      <div id="chatContainer">
        <div id="chatMessages"></div>
        <div id="chatInputContainer">
          <!-- Image preview area above input -->
          <div id="imagePreviewContainer" style="display: none;">
            <img id="imagePreview" />
            <button id="removeImageBtn">×</button>
          </div>
          <!-- Chat Screenshot Preview Area -->
          <div id="chatScreenshotPreviewArea" style="display: none;">
            <div id="chatScreenshotPreviewContainer">
              <span id="chatScreenshotCount">0 screenshots</span>
              <span id="chatProcessHint">Press Enter to send with message</span>
            </div>
          </div>
          <div id="inputRow">
            <input type="text" id="chatInput" placeholder="Ask a question..." />
            <button id="sendBtn">Send</button>
            </div>
            </div>
            </div>
    </div>

    <!-- Button container -->
    <div id="buttonContainer">
      <button class="btn" id="interviewBtn">Interview Helper</button>
      <button class="btn" id="chatBtn">Chat</button>
      <button class="btn clear" id="clearbtn">Clear Page</button>
    </div>
  </div>

  <!-- Prompt Edit Modal -->
  <div id="promptEditModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Edit Screenshot Prompt</div>
        <button class="modal-close" id="modalCloseBtn">×</button>
      </div>
      <div class="modal-body">
        <div class="prompt-info">
          This prompt will be used when processing screenshots in Interview Helper mode. You can customize it to better
          suit your needs.
        </div>
        <textarea id="promptTextarea" class="prompt-textarea" placeholder="Enter your custom prompt here..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" id="resetPromptBtn">Reset to Default</button>
        <button class="modal-btn secondary" id="cancelPromptBtn">Cancel</button>
        <button class="modal-btn primary" id="savePromptBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Include marked library for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Check if marked library is loaded
        document.addEventListener('DOMContentLoaded', function () {
          if (typeof marked === 'undefined') {
            console.error('Marked library not loaded! Using fallback rendering.');
          } else {
            console.log('Marked library loaded successfully');
          }
        });

        // Markdown rendering functions
        function renderMarkdown(text) {
          try {
            if (typeof marked !== 'undefined') {
              return marked.parse(text);
            } else {
              console.warn('Marked library not available, using fallback');
              return formatTextFallback(text);
            }
          } catch (error) {
            console.error('Error parsing markdown:', error);
            return formatTextFallback(text);
          }
        }

        // Fallback text formatting for basic markdown-like rendering
        function formatTextFallback(text) {
          return text
            // Convert code blocks
            .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
            // Convert inline code
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            // Convert bold text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Convert headers
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            // Convert line breaks
            .replace(/\n/g, '<br>');
        }

        function setSolutionContent(content) {
          const solutionEl = document.getElementById('solution');
          if (!content || content.trim() === '') {
            solutionEl.innerHTML = 'Screenshot solution will appear here...';
            solutionEl.classList.add('empty');
            solutionEl.classList.remove('markdown-body');
          } else {
            const renderedContent = renderMarkdown(content);
            solutionEl.innerHTML = renderedContent;
            solutionEl.classList.remove('empty');
            solutionEl.classList.add('markdown-body');
          }
        }

                // Screenshot accumulation for LeetCode Helper
                let accumulatedScreenshots = [];

                function addScreenshotToPreview(imageData) {
                  console.log('addScreenshotToPreview called with data length:', imageData.length);
                  accumulatedScreenshots.push(imageData);
                  console.log('Screenshots array now has:', accumulatedScreenshots.length, 'items');

                  // Update both preview areas
                  updateScreenshotPreview();
                  updateChatScreenshotPreview();

                  // Show the appropriate preview area based on current mode
                  if (currentPage === 'chat') {
                    showChatScreenshotPreviewArea();
                  } else {
                    showScreenshotPreviewArea();
                  }
                  
                  console.log(`Added screenshot, total: ${accumulatedScreenshots.length}`);
                }

                function removeScreenshotFromPreview(index) {
                  accumulatedScreenshots.splice(index, 1);

                  // Update both preview areas
                  updateScreenshotPreview();
                  updateChatScreenshotPreview();
                  
                  if (accumulatedScreenshots.length === 0) {
                    hideScreenshotPreviewArea();
                    hideChatScreenshotPreviewArea();
                  }

                  console.log(`Removed screenshot, total: ${accumulatedScreenshots.length}`);
                }

                function updateScreenshotPreview() {
                  const container = document.getElementById('screenshotPreviewContainer');
                  const countEl = document.getElementById('screenshotCount');

                // Clear existing previews except count and hint
                const previews = container.querySelectorAll('.screenshot-preview');
                previews.forEach(preview => preview.remove());

                // Add new previews
                accumulatedScreenshots.forEach((imageData, index) => {
                  const previewDiv = document.createElement('div');
                  previewDiv.className = 'screenshot-preview';

                const img = document.createElement('img');
                img.src = `data:image/png;base64,${imageData}`;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'screenshot-remove';
                removeBtn.textContent = '×';
                removeBtn.addEventListener('click', () => removeScreenshotFromPreview(index));

                previewDiv.appendChild(img);
                previewDiv.appendChild(removeBtn);

                // Insert before the count element
                container.insertBefore(previewDiv, countEl);
              });

                // Update count
                countEl.textContent = `${accumulatedScreenshots.length} screenshot${accumulatedScreenshots.length !== 1 ? 's' : ''}`;
              }

                                // Chat-specific screenshot preview functions
                                function updateChatScreenshotPreview() {
                                  const container = document.getElementById('chatScreenshotPreviewContainer');
                                  const countEl = document.getElementById('chatScreenshotCount');

                                  // Clear existing previews except count and hint
                                  const previews = container.querySelectorAll('.screenshot-preview');
                                  previews.forEach(preview => preview.remove());

                                  // Add new previews
                                  accumulatedScreenshots.forEach((imageData, index) => {
                                    const previewDiv = document.createElement('div');
                                    previewDiv.className = 'screenshot-preview';

                                    const img = document.createElement('img');
                                    img.src = `data:image/png;base64,${imageData}`;

                                    const removeBtn = document.createElement('button');
                                    removeBtn.className = 'screenshot-remove';
                                    removeBtn.textContent = '×';
                                    removeBtn.addEventListener('click', () => removeScreenshotFromPreview(index));

                                    previewDiv.appendChild(img);
                                    previewDiv.appendChild(removeBtn);

                                    // Insert before the count element
                                    container.insertBefore(previewDiv, countEl);
                                  });

                                  // Update count
                                  countEl.textContent = `${accumulatedScreenshots.length} screenshot${accumulatedScreenshots.length !== 1 ? 's' : ''}`;
                                }

                function showScreenshotPreviewArea() {
                  document.getElementById('screenshotPreviewArea').style.display = 'block';
                }

                function hideScreenshotPreviewArea() {
                  document.getElementById('screenshotPreviewArea').style.display = 'none';
                }

                              function showChatScreenshotPreviewArea() {
                                document.getElementById('chatScreenshotPreviewArea').style.display = 'block';
                              }

                              function hideChatScreenshotPreviewArea() {
                                document.getElementById('chatScreenshotPreviewArea').style.display = 'none';
                              }

                              function clearAccumulatedScreenshots() {
                                accumulatedScreenshots = [];
                                hideScreenshotPreviewArea();
                                hideChatScreenshotPreviewArea();
                                console.log('Cleared all accumulated screenshots');
                              }

              // Loader functions
              function showLoader() {
                document.getElementById('loader').style.display = 'flex';
                console.log('Loader shown');
              }

              function hideLoader() {
                document.getElementById('loader').style.display = 'none';
                console.log('Loader hidden');
              }

                            async function processAccumulatedScreenshots() {
                              if (accumulatedScreenshots.length === 0) {
                                console.log('No screenshots to process');
                                return;
                              }

                            console.log(`Processing ${accumulatedScreenshots.length} accumulated screenshots`);
                              const model = getCurrentModel();
                              const customPrompt = getCustomPrompt();
                              console.log(`Using model: ${model}`);
                              console.log(`Using custom prompt: ${customPrompt.substring(0, 100)}...`);
                            hideScreenshotPreviewArea();
                            showLoader(); // Show loader when processing starts

                            try {
                              if (window.electronAPI) {
                                await window.electronAPI.processAccumulatedScreenshots([...accumulatedScreenshots], model, customPrompt);
                                clearAccumulatedScreenshots();
                              }
                            } catch (error) {
                              console.error('Error processing screenshots:', error);
                            hideLoader(); // Hide loader on error
                              showScreenshotPreviewArea(); // Show preview area again on error
                            }
                          }

                          // Custom prompt management
                          const DEFAULT_PROMPT_SINGLE = "Solve this question, and give me the code for the same.";
                          const DEFAULT_PROMPT_MULTIPLE = "Analyze these screenshots which show different parts of the same coding question. Solve the complete question and provide the code solution.";

                          function getCustomPrompt() {
                            const saved = localStorage.getItem('customScreenshotPrompt');
                            if (saved && saved.trim()) {
                              return saved;
                            }
                            // Return default based on screenshot count
                            return accumulatedScreenshots.length === 1 ? DEFAULT_PROMPT_SINGLE : DEFAULT_PROMPT_MULTIPLE;
                          }

                          function setCustomPrompt(prompt) {
                            localStorage.setItem('customScreenshotPrompt', prompt);
                            console.log('Custom prompt saved:', prompt.substring(0, 50) + '...');
                          }

                          function resetCustomPrompt() {
                            localStorage.removeItem('customScreenshotPrompt');
                            console.log('Custom prompt reset to default');
                          }

                          // Prompt editing modal functionality
                          const promptEditIcon = document.getElementById('promptEditIcon');
                          const promptEditModal = document.getElementById('promptEditModal');
                          const promptTextarea = document.getElementById('promptTextarea');
                          const modalCloseBtn = document.getElementById('modalCloseBtn');
                          const resetPromptBtn = document.getElementById('resetPromptBtn');
                          const cancelPromptBtn = document.getElementById('cancelPromptBtn');
                          const savePromptBtn = document.getElementById('savePromptBtn');

                          // Open modal
                          promptEditIcon.addEventListener('click', () => {
                            const currentPrompt = getCustomPrompt();
                            promptTextarea.value = currentPrompt;
                            promptEditModal.classList.add('show');
                            promptTextarea.focus();
                          });

                          // Close modal
                          function closeModal() {
                            promptEditModal.classList.remove('show');
                          }

                          modalCloseBtn.addEventListener('click', closeModal);
                          cancelPromptBtn.addEventListener('click', closeModal);

                          // Close modal when clicking outside
                          promptEditModal.addEventListener('click', (e) => {
                            if (e.target === promptEditModal) {
                              closeModal();
                            }
                          });

                          // Reset to default
                          resetPromptBtn.addEventListener('click', () => {
                            const defaultPrompt = accumulatedScreenshots.length === 1 ? DEFAULT_PROMPT_SINGLE : DEFAULT_PROMPT_MULTIPLE;
                            promptTextarea.value = defaultPrompt;
                          });

                          // Save prompt
                          savePromptBtn.addEventListener('click', () => {
                            const newPrompt = promptTextarea.value.trim();
                            if (newPrompt) {
                              setCustomPrompt(newPrompt);
                              closeModal();
                              // Show confirmation
                              console.log('Prompt saved successfully');
                            } else {
                              alert('Please enter a valid prompt');
                            }
                          });

                          // Keyboard shortcuts for modal
                          promptTextarea.addEventListener('keydown', (e) => {
                            if (e.key === 'Escape') {
                              closeModal();
                            } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                              savePromptBtn.click();
                            }
                          });

                        // Top bar tooltip functionality
                        const infoIcon = document.getElementById('infoIcon');
                        const shortcutsTooltip = document.getElementById('shortcutsTooltip');

                        infoIcon.addEventListener('mouseenter', () => {
                          shortcutsTooltip.classList.add('show');
                        });

                        infoIcon.addEventListener('mouseleave', () => {
                          shortcutsTooltip.classList.remove('show');
                        });

                                      // Model selector functionality
                                      const modelDropdown = document.getElementById('modelDropdown');
                                      let selectedModel = localStorage.getItem('selectedModel') || 'gemini-1.5-flash';

                                      // Set initial value
                                      modelDropdown.value = selectedModel;

                                      // Handle model change
                                      modelDropdown.addEventListener('change', (e) => {
                                        selectedModel = e.target.value;
                                        localStorage.setItem('selectedModel', selectedModel);
                                        console.log('Model changed to:', selectedModel);
                                      });

                                      // Function to get current model
                                      function getCurrentModel() {
                                        return selectedModel;
                                      }

                                                // Settings functionality
                                                const settingsIcon = document.getElementById('settingsIcon');
                                                const settingsDropdown = document.getElementById('settingsDropdown');
                                                const themeSelector = document.getElementById('themeSelector');
                                                const opacitySlider = document.getElementById('opacitySlider');
                                                const opacityValue = document.getElementById('opacityValue');

                                                // Load saved settings
                                                let currentTheme = localStorage.getItem('theme') || 'dark';
                                                let currentOpacity = parseInt(localStorage.getItem('opacity') || '100');

                                                // Initialize settings
                                                themeSelector.value = currentTheme;
                                                opacitySlider.value = currentOpacity;
                                                opacityValue.textContent = currentOpacity + '%';

                                                // Apply initial theme
                                                document.body.className = currentTheme === 'light' ? 'light-theme' : '';

                                                // Apply initial opacity
                                                if (window.electronAPI && window.electronAPI.setWindowOpacity) {
                                                  window.electronAPI.setWindowOpacity(currentOpacity / 100);
                                                }

                                                // Settings dropdown toggle
                                                settingsIcon.addEventListener('click', (e) => {
                                                  e.stopPropagation();
                                                  settingsDropdown.classList.toggle('show');
                                                  // Hide info tooltip if open
                                                  shortcutsTooltip.classList.remove('show');
                                                });

                                                // Close settings dropdown when clicking outside
                                                document.addEventListener('click', (e) => {
                                                  if (!settingsIcon.contains(e.target)) {
                                                    settingsDropdown.classList.remove('show');
                                                  }
                                                });

                                                // Prevent dropdown from closing when clicking inside
                                                settingsDropdown.addEventListener('click', (e) => {
                                                  e.stopPropagation();
                                                });

                                                // Theme change handler
                                                themeSelector.addEventListener('change', (e) => {
                                                  currentTheme = e.target.value;
                                                  localStorage.setItem('theme', currentTheme);

                                                  // Apply theme
                                                  document.body.className = currentTheme === 'light' ? 'light-theme' : '';
                                                  console.log('Theme changed to:', currentTheme);
                                                });

                                                // Opacity change handler
                                                opacitySlider.addEventListener('input', (e) => {
                                                  currentOpacity = parseInt(e.target.value);
                                                  opacityValue.textContent = currentOpacity + '%';
                                                  localStorage.setItem('opacity', currentOpacity.toString());

                                                  // Apply opacity to window
                                                  if (window.electronAPI && window.electronAPI.setWindowOpacity) {
                                                    window.electronAPI.setWindowOpacity(currentOpacity / 100);
                                                  }
                                                  console.log('Opacity changed to:', currentOpacity + '%');
                                                });

                                                                                                                  // Logout functionality
                                                                                                                  const logoutIcon = document.getElementById('logoutIcon');
                                                                                                                  const logoutTooltip = document.getElementById('logoutTooltip');

                                                                                                                  // Logout tooltip toggle
                                                                                                                  logoutIcon.addEventListener('mouseenter', () => {
                                                                                                                    logoutTooltip.classList.add('show');
                                                                                                                    // Hide other tooltips/dropdowns
                                                                                                                    shortcutsTooltip.classList.remove('show');
                                                                                                                    settingsDropdown.classList.remove('show');
                                                                                                                  });

                                                                                                                  logoutIcon.addEventListener('mouseleave', () => {
                                                                                                                    logoutTooltip.classList.remove('show');
                                                                                                                  });

                                                                                                                  // Logout click handler
                                                                                                                  logoutIcon.addEventListener('click', async (e) => {
                                                                                                                    e.stopPropagation();

                                                                                                                    // Hide tooltip
                                                                                                                    logoutTooltip.classList.remove('show');

                                                                                                                    // Show confirmation (optional)
                                                                                                                    const confirmed = confirm('Are you sure you want to logout?');
                                                                                                                    if (!confirmed) return;

                                                                                                                    try {
                                                                                                                      if (window.electronAPI && window.electronAPI.logout) {
                                                                                                                        console.log('Logging out...');

                                                                                                                        // Clear any local data
                                                                                                                        clearLocalData();

                                                                                                                        // Call logout API
                                                                                                                        const result = await window.electronAPI.logout();

                                                                                                                        if (result.success) {
                                                                                                                          console.log('Logout successful');
                                                                                                                          // The main process will handle window switching
                                                                                                                        } else {
                                                                                                                          console.error('Logout failed:', result.error);
                                                                                                                          alert('Logout failed. Please try again.');
                                                                                                                        }
                                                                                                                      } else {
                                                                                                                        console.error('Logout API not available');
                                                                                                                        alert('Logout functionality not available');
                                                                                                                      }
                                                                                                                    } catch (error) {
                                                                                                                      console.error('Logout error:', error);
                                                                                                                      alert('Logout error: ' + error.message);
                                                                                                                    }
                                                                                                                  });

                                                                                                                  // Function to clear local application data
                                                                                                                  function clearLocalData() {
                                                                                                                    try {
                                                                                                                      // Clear chat messages and history
                                                                                                                      const chatMessages = document.getElementById('chatMessages');
                                                                                                                      if (chatMessages) {
                                                                                                                        chatMessages.innerHTML = '';
                                                                                                                      }
                                                                                                                      chatHistory = []; // Clear conversation history

                                                                                                                      // Clear solution content
                                                                                                                      setSolutionContent('');

                                                                                                                      // Clear accumulated screenshots
                                                                                                                      clearAccumulatedScreenshots();

                                                                                                                      // Clear any input fields
                                                                                                                      const chatInput = document.getElementById('chatInput');
                                                                                                                      if (chatInput) {
                                                                                                                        chatInput.value = '';
                                                                                                                      }

                                                                                                                      // Hide image preview if any
                                                                                                                      hideImagePreview();

                                                                                                                      console.log('Local data and chat history cleared');
                                                                                                                    } catch (error) {
                                                                                                                      console.error('Error clearing local data:', error);
                                                                                                                    }
                                                                                                                  }

    // Page management
    const notesPage = document.getElementById('notesPage');
    const chatPage = document.getElementById('chatPage');
    const chatBtn = document.getElementById('chatBtn');
                              const interviewBtn = document.getElementById('interviewBtn');

    let currentPage = 'notes';

                          // Initialize the page state - Interview Helper should be active by default
                          function initializePageState() {
                            showPage('notes'); // This will set the Interview Helper button as active
                          }

    function showPage(pageName) {
      if (pageName === 'chat') {
        notesPage.classList.remove('active');
        chatPage.classList.add('active');
        chatBtn.classList.add('active');
        interviewBtn.classList.remove('active');
        currentPage = 'chat';

        // Show chat screenshot preview area if we have accumulated screenshots
        if (accumulatedScreenshots.length > 0) {
          showChatScreenshotPreviewArea();
          hideScreenshotPreviewArea();
        }
      } else {
        chatPage.classList.remove('active');
        notesPage.classList.add('active');
        chatBtn.classList.remove('active');
        interviewBtn.classList.add('active');
        currentPage = 'notes';

        // Show interview screenshot preview area if we have accumulated screenshots
        if (accumulatedScreenshots.length > 0) {
          showScreenshotPreviewArea();
          hideChatScreenshotPreviewArea();
        }
      }
    }

                // Chat functionality with markdown support
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                const imagePreview = document.getElementById('imagePreview');
                const removeImageBtn = document.getElementById('removeImageBtn');

                let currentImageData = null;
                                                                                          let chatHistory = []; // Store conversation history

                function addMessage(text, type = 'user', imageData = null) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;

                if (imageData && type === 'user') {
                  // Add image to user message
                  const img = document.createElement('img');
                  img.src = `data:image/png;base64,${imageData}`;
                  img.style.maxWidth = '200px';
                  img.style.borderRadius = '8px';
                  img.style.marginBottom = '8px';
                  img.style.display = 'block';
                  messageEl.appendChild(img);
                }

                if (text) {
                if (type === 'ai') {
                  // Render AI messages as markdown
                  const renderedContent = renderMarkdown(text);
                  messageEl.innerHTML = (imageData && type === 'user' ? messageEl.innerHTML : '') + renderedContent;
                  messageEl.classList.add('markdown-body');
                } else {
                // User messages remain as plain text
                const textNode = document.createTextNode(text);
                messageEl.appendChild(textNode);
              }
              }

      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;

                  // Add to chat history for context (exclude error messages)
                  if (type !== 'error' && text) {
                    const historyEntry = {
                      role: type === 'user' ? 'user' : 'assistant',
                      content: text
                    };

                    // Include image in history if present
                    if (imageData && type === 'user') {
                      historyEntry.image = imageData;
                    }

                    chatHistory.push(historyEntry);
                    console.log('Chat history updated. Total messages:', chatHistory.length);
                  }
    }

                function showImagePreview(imageData) {
                  currentImageData = imageData;
                  imagePreview.src = `data:image/png;base64,${imageData}`;
                  imagePreviewContainer.style.display = 'block';
                  chatInput.placeholder = 'Ask about this image...';
                }

                function hideImagePreview() {
                  currentImageData = null;
                  imagePreview.src = '';
                  imagePreviewContainer.style.display = 'none';
                  chatInput.placeholder = 'Ask a question...';
                }

    function sendMessage() {
      const text = chatInput.value.trim();
      const hasAccumulatedScreenshots = accumulatedScreenshots.length > 0;
      const hasSingleImage = currentImageData && !hasAccumulatedScreenshots;

      if (!text && !hasSingleImage && !hasAccumulatedScreenshots) return;

      // Determine which image data to use
      let imageToSend = null;
      if (hasAccumulatedScreenshots) {
        // Use the first accumulated screenshot for display in chat
        imageToSend = accumulatedScreenshots[0];
        console.log(`Sending message with ${accumulatedScreenshots.length} accumulated screenshots`);
      } else if (hasSingleImage) {
        imageToSend = currentImageData;
        console.log('Sending message with single image');
      }

      // Add user message with image if present
      addMessage(text, 'user', imageToSend);

      // Prepare data for sending
      const messageText = text || null;
      const imageData = hasAccumulatedScreenshots ? accumulatedScreenshots[0] : currentImageData;
      const model = getCurrentModel();

      // Clear input and images
      chatInput.value = '';
      hideImagePreview();
      if (hasAccumulatedScreenshots) {
        clearAccumulatedScreenshots();
      }
      
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      // Send to backend with model selection and chat history for context
      if (window.electronAPI) {
        console.log('Sending message with chat history:', chatHistory.length, 'previous messages');
        window.electronAPI.sendChatMessage(messageText, imageData, model, chatHistory);
      }
    }

    // Button event listeners
    chatBtn.addEventListener('click', () => showPage('chat'));
                              interviewBtn.addEventListener('click', () => {
      // Always go to Interview Helper page
      showPage('notes');
    });

      // Dynamic clear button (Button 3) - clears based on current page
                                document.getElementById('clearbtn').addEventListener('click', () => {
        if (currentPage === 'chat') {
          // Clear chat messages, history, and accumulated screenshots
          chatMessages.innerHTML = '';
          chatHistory = []; // Clear conversation history
          clearAccumulatedScreenshots(); // Clear accumulated screenshots
          hideImagePreview(); // Hide single image preview
          hideChatScreenshotPreviewArea(); // Hide chat screenshot preview area
          console.log('Chat history, messages, and screenshots cleared');
        } else {
          // Clear solution and accumulated screenshots
          setSolutionContent('');
          clearAccumulatedScreenshots();
          console.log('Interview Helper page cleared');
      }
    });

    // Chat input handlers
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

                                                          removeImageBtn.addEventListener('click', () => {
                                                            hideImagePreview();
                                                            clearAccumulatedScreenshots(); // Also clear accumulated screenshots
                                                            hideChatScreenshotPreviewArea(); // Hide chat screenshot preview area
                                                          });

                        // Handle screenshot for chat mode                
                function onChatScreenshotCaptured(imageData) {
                  console.log('Chat screenshot captured, adding to accumulated screenshots');
                  addScreenshotToPreview(imageData);

                  // Hide single image preview when we have accumulated screenshots
                  // The screenshot preview area will handle showing multiple screenshots
                  if (accumulatedScreenshots.length > 0) {
                    hideImagePreview();
                  }
                }

    // Handle electron API
    if (window.electronAPI) {


      // Chat response handlers
      window.electronAPI.onChatResponse((response) => {
        addMessage(response, 'ai');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      });

      window.electronAPI.onChatError((error) => {
        addMessage(`Error: ${error}`, 'error');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      });

      // Screenshot handlers with markdown rendering
      window.electronAPI.onScreenshotSolution((solution) => {
        console.log('Received solution:', solution);
        console.log('Solution length:', solution.length);
        
        // Hide loader when solution is received
        hideLoader();
        
        // Set the solution with markdown rendering
        setSolutionContent(solution);
        console.log('Solution set with markdown rendering');

        // Auto-clear after 60 seconds
        setTimeout(() => {
          setSolutionContent('');
          console.log('Auto-cleared solution after 60 seconds');
        }, 60000);
      });

      window.electronAPI.onScreenshotError((error) => {
        console.error('Screenshot error:', error);

        // Hide loader on error
        hideLoader();

        // Show error notification to user
        showErrorNotification(error);

        // Also show error message in the solution area
        const errorMessage = `⚠️ Error: ${error}`;
        setSolutionContent(errorMessage);

        // Auto-clear error after 10 seconds
        setTimeout(() => {
          setSolutionContent('');
        }, 10000);
      });

      // LeetCode Helper screenshot accumulation
      window.electronAPI.onLeetcodeScreenshotCaptured((imageData) => {
        console.log('Received screenshot for LeetCode Helper, currentPage:', currentPage);
        console.log('Image data length:', imageData.length);
        if (currentPage === 'notes') {
          console.log('Adding screenshot to preview...');
          addScreenshotToPreview(imageData);
        } else {
          console.log('Not in notes page, ignoring screenshot');
        }
      });

      // Mode detection for screenshot shortcut
      function onCheckCurrentMode() {
        console.log('Current mode check, current page:', currentPage);
        if (currentPage === 'chat') {
          // In chat mode - take screenshot and add to chat input
          window.electronAPI.takeScreenshotForMode('chat');
        } else if (currentPage === 'notes') {
          // In interview mode - take screenshot and add to accumulation
          window.electronAPI.takeScreenshotForMode('interview');
        }
      }

      // Loading state for screenshots
      document.addEventListener('keydown', (e) => {
        if (e.metaKey && e.shiftKey && e.key === '1') {
          if (currentPage !== 'notes') showPage('notes');
        }
      });

      // Handle global shortcut for processing accumulated screenshots
      window.electronAPI.onProcessAccumulatedScreenshots(() => {
        console.log('Global Cmd+Enter pressed, currentPage:', currentPage, 'screenshots:', accumulatedScreenshots.length);
        if (currentPage === 'notes' && accumulatedScreenshots.length > 0) {
          console.log('Processing accumulated screenshots...');
          processAccumulatedScreenshots();
        } else {
          console.log('Not processing - either wrong page or no screenshots');
        }
      });

      // Handle global Cmd+Enter shortcut - decide action based on current mode
      window.electronAPI.onHandleCmdEnter(() => {
        console.log('Global Cmd+Enter received, currentPage:', currentPage);

        if (currentPage === 'chat') {
          // In chat mode - check if input is focused and send message
          const chatInput = document.getElementById('chatInput');
          if (document.activeElement === chatInput || chatInput.value.trim() || currentImageData || accumulatedScreenshots.length > 0) {
            console.log('Sending chat message via global Cmd+Enter');
            sendMessage();
          }
        } else if (currentPage === 'notes' && accumulatedScreenshots.length > 0) {
          // In interview mode with screenshots - process them
          console.log('Processing accumulated screenshots via global Cmd+Enter');
          processAccumulatedScreenshots();
        }
      });

      // Handle screenshot captured for chat mode
      window.electronAPI.onChatScreenshotCaptured(onChatScreenshotCaptured);

      // Register mode check handler
      window.electronAPI.onCheckCurrentMode(onCheckCurrentMode);

      // Handle global Cmd+Shift+I shortcut to switch to chat mode
      window.electronAPI.onSwitchToChatMode(() => {
        console.log('Global Cmd+Shift+I received, switching to chat mode');

        // Switch to chat page
        showPage('chat');

        // Focus the chat input field with longer delay and force focus
        setTimeout(() => {
          const chatInput = document.getElementById('chatInput');
          if (chatInput) {
            // Force focus and click to ensure it's properly focused
            chatInput.focus();
            chatInput.click();
            console.log('Chat input focused and clicked');

            // Also scroll input into view if needed
            chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } else {
            console.log('Chat input not found');
          }
        }, 200); // Increased delay to ensure page switch completes
      });
    }

    // Error notification functions
    function showErrorNotification(message) {
      const errorEl = document.getElementById('errorNotification');
      const messageEl = document.getElementById('errorMessage');
      messageEl.textContent = message;
      errorEl.classList.add('show');

      // Auto-hide after 15 seconds
      setTimeout(() => {
        hideErrorNotification();
      }, 15000);
    }

    function hideErrorNotification() {
      const errorEl = document.getElementById('errorNotification');
      errorEl.classList.remove('show');
    }

  // Initialize page state - set Interview Helper as active by default
  document.addEventListener('DOMContentLoaded', () => {
    // Set Interview Helper button as active since we start in notes mode
    interviewBtn.classList.add('active');
    chatBtn.classList.remove('active');
  });
  </script>
</body>

</html>